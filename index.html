<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ğŸ’° Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…ØªØ¬Ø±</title>
  <style>
    body { font-family: "Cairo", sans-serif; margin:0; background:#f5f6fa; direction:rtl; font-size:20px; }
    header { background:#2c3e50; color:white; padding:25px; text-align:center; font-size:28px; }
    nav { display:flex; justify-content:center; gap:20px; background:#34495e; padding:15px; flex-wrap:wrap; }
    nav button { background:#1abc9c; border:none; color:white; padding:20px 40px; border-radius:12px; cursor:pointer; font-size:22px; font-weight:bold; }
    nav button:hover { background:#16a085; }
    section { display:none; max-width:1000px; margin:30px auto; background:white; padding:30px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.15); font-size:22px; }
    section.active { display:block; }
    label { display:block; margin-top:15px; font-weight:bold; font-size:22px; }
    input,button { margin:8px 0; padding:18px; border-radius:10px; border:1px solid #bbb; width:100%; box-sizing:border-box; font-size:22px; }
    button.action { background:#3498db; color:white; border:none; width:100%; font-size:24px; font-weight:bold; }
    button.action:hover { background:#2980b9; }
    table { width:100%; border-collapse:collapse; margin-top:20px; font-size:20px; }
    th,td { border:1px solid #ddd; padding:12px; text-align:center; }
    th { background:#ecf0f1; font-size:22px; }

    /* Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ â€” Ø´Ø§Ø´Ø© ÙƒØ§Ù…Ù„Ø© Ø¨Ø¯ÙˆÙ† Ø¥Ø·Ø§Ø± */
    #scanner {
      display:none;
      position:fixed;
      inset:0;
      background:#000;
      z-index:9998;
    }
    #scannerHeader{
      position:absolute; top:10px; left:10px; right:10px;
      display:flex; justify-content:space-between; align-items:center; z-index:9999;
      color:#fff; font-size:18px; padding:0 8px;
    }
    #closeScan {
      background:#e74c3c; border:none; color:#fff; padding:10px 16px; border-radius:10px; cursor:pointer; font-size:18px;
    }
    #video { width:100vw; height:100vh; object-fit:cover; }

    #lastScan { text-align:center; font-size:24px; margin-top:10px; font-weight:bold; color:#2c3e50; }
    .btn-sm { padding:10px 20px; font-size:20px; margin:5px; border-radius:8px; cursor:pointer; }
    .edit { background:#f39c12; color:white; border:none; }
    .delete { background:#e74c3c; color:white; border:none; }

    /* Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© */
    .modal {
      display: none; position: fixed; z-index: 9999;
      left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: #fff;
      margin: 10% auto;
      padding: 25px;
      border-radius: 12px;
      width: 90%; max-width: 400px;
      text-align: center;
      box-shadow:0 5px 15px rgba(0,0,0,0.3);
      font-size: 20px;
      border-top: 6px solid #1abc9c;
    }
    .modal-content h2 { margin-bottom: 15px; color:#2c3e50; }
    .modal-content p { margin:15px 0; line-height:1.6; }
    .close {
      position: absolute; right: 20px; top: 15px;
      font-size: 28px; font-weight: bold;
      color:#e74c3c; cursor: pointer;
    }
    .ok-btn {
      background: #1abc9c;
      color: #fff;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
    }
    .ok-btn:hover { background:#16a085; }
  </style>
</head>
<body>
  <header>ğŸ’° Ù†Ø¸Ø§Ù… Ù…Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…ØªØ¬Ø±</header>
  <nav>
    <button onclick="showPage('sell')">ğŸ’µ Ø§Ù„Ø¨ÙŠØ¹</button>
    <button onclick="showPage('products')">ğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
    <button onclick="showPage('profit')">ğŸ“ˆ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</button>
    <button onclick="showPage('history')">ğŸ“Š Ø§Ù„Ø³Ø¬Ù„</button>
  </nav>

  <!-- ØµÙØ­Ø© Ø§Ù„Ø¨ÙŠØ¹ -->
  <section id="sell" class="active">
    <h2>ğŸ’µ Ø¨ÙŠØ¹ Ù…Ù†ØªØ¬</h2>
    <label>ğŸ“¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
    <input id="sellBarcode" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">
    <button class="btn-sm" onclick="startScanner('sell')">ğŸ“· Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯</button>

    <label>ğŸ”¢ Ø§Ù„ÙƒÙ…ÙŠØ©</label>
    <input id="sellQty" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" value="1">

    <label>ğŸ’² Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</label>
    <input id="sellPrice" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">

    <button class="action" onclick="processTransaction()">âœ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¨ÙŠØ¹</button>
  </section>

  <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
  <section id="products">
    <h2>ğŸ›’ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
    <label>ğŸ’² Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©</label>
    <input id="pprice" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©">

    <label>ğŸ“¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</label>
    <input id="pbarcode" placeholder="Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯">
    <button class="btn-sm" onclick="startScanner('product')">ğŸ“· Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯</button>

    <label>ğŸ”¢ Ø§Ù„ÙƒÙ…ÙŠØ©</label>
    <input id="pstock" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">

    <button class="action" onclick="addOrUpdateProduct()">â• Ø¥Ø¶Ø§ÙØ© / ØªØ­Ø¯ÙŠØ«</button>

    <h2>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
    <p>ğŸ’° Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒÙ„ÙŠØ© Ù„Ù„Ø¨Ø¶Ø§Ø¹Ø©: <span id="inventoryValue">0</span></p>
    <table id="productsTable">
      <thead><tr><th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th><th>Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- ØµÙØ­Ø© Ø§Ù„Ø±Ø¨Ø­ -->
  <section id="profit">
    <h2>ğŸ“ˆ ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</h2>
    <p>ğŸ’µ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: <span id="totalSales">0</span></p>
    <p>ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©: <span id="totalCost">0</span></p>
    <p>âœ… ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: <span id="netProfit">0</span></p>
  </section>

  <!-- ØµÙØ­Ø© Ø§Ù„Ø³Ø¬Ù„ -->
  <section id="history">
    <h2>ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2>
    <button onclick="exportData()">ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    <button onclick="document.getElementById('importFile').click()">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø¹ Ø¯Ù…Ø¬</button>

    <table id="historyTable">
      <thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ø´Ø§Ø´Ø© ÙƒØ§Ù…Ù„Ø©) -->
  <div id="scanner">
    <div id="scannerHeader">
      <div>ğŸ“· Ø§Ù„Ù…Ø§Ø³Ø­ ÙŠØ¹Ù…Ù„ â€” ÙˆØ¬Ù‘Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</div>
      <button id="closeScan" onclick="stopScanner()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <video id="video" autoplay playsinline></video>
  </div>
  <div id="lastScan"></div>

  <!-- Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© -->
  <div id="mergeModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2>ğŸ“Š Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</h2>
      <p id="mergeMessage"></p>
      <button onclick="closeModal()" class="ok-btn">Ù…ÙˆØ§ÙÙ‚</button>
    </div>
  </div>

  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <script>
    let products = JSON.parse(localStorage.getItem("products") || "[]");
    let transactions = JSON.parse(localStorage.getItem("transactions") || "[]");
    let scannerMode = null;
    let codeReader = null;
    let stopAfterFirst = false;

    function saveData(){
      localStorage.setItem("products", JSON.stringify(products));
      localStorage.setItem("transactions", JSON.stringify(transactions));
    }

    function loadProducts(){
      const tbody=document.querySelector("#productsTable tbody");
      tbody.innerHTML="";
      let total=0;
      products.forEach(p=>{
        tbody.innerHTML+=`<tr>
          <td>${p.barcode}</td>
          <td>${p.price}</td>
          <td>${p.stock}</td>
          <td>
            <button class="btn-sm edit" onclick="editProduct('${p.barcode}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn-sm delete" onclick="deleteProduct('${p.barcode}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </td>
        </tr>`;
        total+= (parseFloat(p.price)||0) * (parseInt(p.stock)||0);
      });
      document.getElementById("inventoryValue").textContent=total.toFixed(2);
    }

    function addOrUpdateProduct(){
      const price=parseFloat(document.getElementById("pprice").value)||0;
      const barcode=document.getElementById("pbarcode").value.trim();
      const stock=parseInt(document.getElementById("pstock").value)||0;
      if(!barcode) return alert("âŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯");
      let p=products.find(x=>x.barcode===barcode);
      if(p){
        p.price = (price || p.price);
        p.stock = (parseInt(p.stock)||0) + stock;
      } else {
        products.push({barcode,price,stock});
      }
      saveData(); loadProducts();
    }

    function editProduct(b){
      let p=products.find(x=>x.barcode===b);
      if(!p) return;
      document.getElementById("pbarcode").value=p.barcode;
      document.getElementById("pprice").value=p.price;
      document.getElementById("pstock").value=p.stock;
      showPage("products");
    }

    function deleteProduct(b){
      products=products.filter(p=>p.barcode!==b);
      saveData(); loadProducts();
    }

    function recordTransaction(b,q,pr){
      const p=products.find(x=>x.barcode===b);
      const costPerUnit = p ? (parseFloat(p.price)||0) : 0;
      transactions.push({
        type:"Ø¨ÙŠØ¹",
        barcode:b,
        qty:q,
        price:pr,
        total:pr*q,
        cost: costPerUnit*q,
        date:new Date().toLocaleString()
      });
      saveData();
    }

    // âœ… Ø§Ù„Ø¨ÙŠØ¹ Ø­ØµØ±Ø§Ù‹ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬
    function processTransaction(){
      const b=document.getElementById("sellBarcode").value.trim();
      const q=parseInt(document.getElementById("sellQty").value)||0;
      const pr=parseFloat(document.getElementById("sellPrice").value)||0;

      if(!b) return alert("âŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯");
      if(q<=0) return alert("âŒ Ø£Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©");
      if(pr<=0) return alert("âŒ Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø¨ÙŠØ¹ ØµØ­ÙŠØ­");

      let p=products.find(x=>x.barcode===b);
      if(!p) return alert("âŒ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ â€” Ø£Ø¶ÙÙ‡ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª");

      if((p.stock||0) < q) return alert("âŒ Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± ÙƒØ§ÙÙ");

      // Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
      p.stock -= q;
      recordTransaction(b,q,pr);
      saveData(); loadProducts();
      alert("âœ” ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹");
      document.getElementById("sellBarcode").value="";
      document.getElementById("sellQty").value="1";
      document.getElementById("sellPrice").value="";
    }

    function calcProfit(){
      let s=0,c=0;
      transactions.forEach(t=>{ s+= (t.price||0)*(t.qty||0); c+= (t.cost||0); });
      document.getElementById("totalSales").textContent=s.toFixed(2);
      document.getElementById("totalCost").textContent=c.toFixed(2);
      document.getElementById("netProfit").textContent=(s-c).toFixed(2);
    }

    function loadHistory(){
      const tbody=document.querySelector("#historyTable tbody");
      tbody.innerHTML="";
      transactions.forEach(t=>{
        tbody.innerHTML+=`<tr>
          <td>${t.type}</td>
          <td>${t.barcode}</td>
          <td>${t.qty}</td>
          <td>${t.price}</td>
          <td>${t.total}</td>
          <td>${t.date}</td>
        </tr>`;
      });
    }

    function showPage(id){
      document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      if(id==="products") loadProducts();
      if(id==="profit") calcProfit();
      if(id==="history") loadHistory();
    }

    // ğŸ“¤ ØªØµØ¯ÙŠØ±
    function exportData() {
      const data = { products: products, transactions: transactions };
      const dataStr = JSON.stringify(data, null, 2);
      const blob = new Blob([dataStr], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "store_backup.json"; a.click();
      URL.revokeObjectURL(url);
    }

    // ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø¹ Ø¯Ù…Ø¬ + Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©
    function importData(event){
      const file = event.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e=>{
        try {
          const imported = JSON.parse(e.target.result);

          let newProducts = 0, updatedProducts = 0, addedTransactions = 0;

          if(imported.products){
            imported.products.forEach(newProd=>{
              let existing = products.find(p=>p.barcode === newProd.barcode);
              if(existing){
                let updated=false;
                if(typeof newProd.price === "number" && newProd.price !== existing.price){
                  existing.price=newProd.price; updated=true;
                }
                if(typeof newProd.stock === "number"){
                  existing.stock=(existing.stock||0)+(newProd.stock||0); updated=true;
                }
                if(updated) updatedProducts++;
              } else {
                products.push(newProd); newProducts++;
              }
            });
          }

          if(imported.transactions){
            imported.transactions.forEach(tr=>{
              transactions.push(tr);
              addedTransactions++;
            });
          }

          saveData(); loadProducts(); loadHistory();

          let msg = `ğŸ“¦ Ù…Ù†ØªØ¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©: ${newProducts}<br>ğŸ”„ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø­Ø¯Ù‘Ø«Ø©: ${updatedProducts}<br>ğŸ“ Ø³Ø¬Ù„Ø§Øª Ù…Ø¶Ø§ÙØ©: ${addedTransactions}`;
          document.getElementById("mergeMessage").innerHTML = msg;
          document.getElementById("mergeModal").style.display = "block";

        } catch(err){
          alert("âŒ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ø¹Ø·ÙˆØ¨");
        }
      };
      reader.readAsText(file);
    }

    function closeModal(){ document.getElementById("mergeModal").style.display="none"; }

    // ğŸ“· Ø§Ù„Ù…Ø§Ø³Ø­ (ZXing) â€” Ø´Ø§Ø´Ø© ÙƒØ§Ù…Ù„Ø© + Ù…Ø³Ø­ Ù…Ø³ØªÙ…Ø±
    async function startScanner(mode){
      scannerMode=mode;
      stopAfterFirst=false;

      document.getElementById("scanner").style.display="block";
      document.getElementById("lastScan").textContent="";

      if(codeReader){ try{ codeReader.reset(); }catch(e){} }
      codeReader=new ZXing.BrowserMultiFormatReader();

      try{
        const constraints = {
          video: {
            facingMode: { ideal: "environment" },
            width: { ideal: 1920 },
            height:{ ideal: 1080 }
          }
        };

        await codeReader.decodeFromVideoDevice(null, "video", (result, err) => {
          if (stopAfterFirst) return;
          if (result) {
            stopAfterFirst = true;
            document.getElementById("beep").play();
            const code = result.text || "";
            document.getElementById("lastScan").textContent = "âœ… Ø¢Ø®Ø± Ø¨Ø§Ø±ÙƒÙˆØ¯: " + code;

            if(scannerMode==="sell") document.getElementById("sellBarcode").value = code;
            if(scannerMode==="product") document.getElementById("pbarcode").value = code;

            stopScanner();
          }
        }, constraints);

      }catch(err){
        console.error(err);
        document.getElementById("lastScan").textContent="âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù";
      }
    }

    function stopScanner(){
      try{
        if(codeReader){ codeReader.reset(); }
      }catch(e){}
      document.getElementById("scanner").style.display="none";
    }

    loadProducts();
  </script>
</body>
</html>
